<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <title>Customer Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.css}">

</head>
<style>
    *{
        font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }
</style>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <p class="navbar-brand">Hello, <span th:text="${clientName}"></span>!</p>
        <form th:action="@{/logout}" method="post" class="form-inline my-2 my-lg-0">
            <button value="Logout" type="submit" class="btn btn-danger">Logout</button>
        </form>
    </div>
</nav>

<div id="message" class="alert alert-success mt-3 d-none"></div>

<main class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="info">
                <h4 class="mb-3">Current Balance</h4>
                <h2 class="balance" th:text="'$' + ${balance}"></h2>
                <p class="logDate">As of <span th:text="${currentDate}"></span></p>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="row g-4 justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            Deposit Money
                        </div>
                        <div class="card-body">
                            <form id="depositForm">
                                <div class="mb-3">
                                    <label for="depositAmount" class="form-label">Amount</label>
                                    <input type="number" class="form-control" id="depositAmount" name="depositAmount" min="1" step="0.05" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Deposit &rarr;</button>
                                <div id="depositError" class="mt-3 text-danger"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row g-4 mt-3 justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            Withdraw Money
                        </div>
                        <div class="card-body">
                            <form id="withdrawForm">
                                <div class="mb-3">
                                    <label for="withdrawAmount" class="form-label">Amount</label>
                                    <input type="number" class="form-control" id="withdrawAmount" step="0.05" min="1" max="5000" name="withdrawAmount" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Withdraw &rarr;</button>
                                <div id="withdrawError" class="mt-3 text-danger"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <div class="col-md-6">
            <div class="row g-4 justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            Transfer Money
                        </div>
                        <div class="card-body">
                            <form id="transferForm">
                                <div class="form-group mb-3">
                                    <label for="transferTo">Transfer to</label>
                                    <input type="text" class="form-control"  id="transferTo" name="transferTo">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="transferAmount">Amount</label>
                                    <input type="number" class="form-control" id="transferAmount" min="1" max="5000" step="0.05" name="transferAmount" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Transfer &rarr;</button>
                                <div id="transferError" class="mt-3 text-danger"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mt-3 justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            Close Account
                        </div>
                        <div class="card-body">
                            <form id="closeForm">
                                <div class="form-group mb-3">
                                    <label for="user">Confirm user</label>
                                    <input type="text" class="form-control" id="user" name="user" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="pin">Confirm PIN</label>
                                    <input type="password" class="form-control" id="pin" name="pin" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Close Account &rarr;</button>
                                <div id="closeError" class="mt-3 text-danger"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 justify-content-center m-5">
        <div class="col-md-6 text-center">
            <div class="timer">You will be logged out in <b class="timer_time">0:00</b></div>
        </div>
    </div>
</main>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script> <!-- Include SHA-256 library -->

<script>
    $('#withdrawForm').submit(function (e) {
        e.preventDefault();
        let withdrawAmount = $('#withdrawAmount').val();
        $.ajax({
            url: '/customer-dashboard/banking-system/withdraw',
            method: 'POST',
            data: { amount: withdrawAmount },
            success: function (response) {
                // Assuming the response directly gives the new balance value
                $('.balance').text("$ "+response);


                // Show success message
                $('#message').addClass('alert-success text-center').text('Withdrawal operation is successful').removeClass('d-none').fadeIn().delay(4000).fadeOut(function() {
                    $(this).addClass('d-none').removeClass('alert-success');
                });

            },
            error: function (jqXHR) {
                $('#withdrawError').text(jqXHR.responseText).fadeIn().delay(3000).fadeOut();
            }
        });
    });

    $('#depositForm').submit(function (e) {
        e.preventDefault();
        let depositAmount = $('#depositAmount').val();
        $.ajax({
            url: '/customer-dashboard/banking-system/deposit',
            method: 'POST',
            data: { amount: depositAmount },
            success: function (response) {
                // Assuming the response directly gives the new balance value
                $('.balance').text("$ "+response);

                // Show success message
                $('#message').addClass('alert-success text-center').text('Deposit operation is successful').removeClass('d-none').fadeIn().delay(4000).fadeOut(function() {
                    $(this).addClass('d-none').removeClass('alert-success');
                });
            },
            error: function (jqXHR) {
                $('#depositError').text(jqXHR.responseText).fadeIn().delay(3000).fadeOut();
            }
        });
    });

    $('#transferForm').submit(function (e) {
        e.preventDefault();
        let transferAmount = $('#transferAmount').val();
        let transferTo = $('#transferTo').val();

        $.ajax({
            url: '/customer-dashboard/banking-system/transfer',
            method: 'POST',
            data: { amount: transferAmount ,transferTo:transferTo},
            success: function (response) {
                $('.balance').text("$ "+response);
                // Show success message
                $('#message').addClass('alert-success text-center').text(transferAmount+ ' Transferred successfully to '+transferTo ).removeClass('d-none').fadeIn().delay(4000).fadeOut(function() {
                    $(this).addClass('d-none').removeClass('alert-success');
                });

            },
            error: function (jqXHR) {
                $('#transferError').text(jqXHR.responseText).fadeIn().delay(3000).fadeOut();

            }
        });
    });

    $('#closeForm').submit(function (e) {
        e.preventDefault();
        let user = $('#user').val();
        let pin = $('#pin').val();
        let hashedPin = sha256(pin);

        $.ajax({
            url: '/customer-dashboard/banking-system/close',
            method: 'POST',
            data: { user: user ,pin:pin},
            success: function (response) {
                $.ajax({
                    url: '/logout',
                    method: 'POST',
                });            },
            error: function (jqXHR) {
                $('#closeError').text(jqXHR.responseText).fadeIn().delay(3000).fadeOut();
            }
        });
    });


    const timer = document.querySelector('.timer_time');
    const LogOutTimer = function () {
        let time = 240;
        let ti = setInterval(function () {
            let sec = String(time % 60).padStart(2, '0');
            let min = String(Math.trunc(time / 60)).padStart(2, '0');
            timer.innerHTML = `${min}:${sec}`;
            if (time === 0) {
                clearInterval(ti);
                $.ajax({
                    url: '/logout',
                    method: 'POST',
                });
            }
            time--;
        }, 1000);
        return ti;
    };
    let logoutInterval = LogOutTimer();

    const resetLogoutTimer = function () {
        clearInterval(logoutInterval);
        logoutInterval = LogOutTimer();
    };

    $(document).ready(function () {
        resetLogoutTimer();
    });



</script>
</body>
</html>